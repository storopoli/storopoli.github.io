<!DOCTYPE html>
<html>
  <head id="head">
    <meta charset="UTF-8">
    <meta name="description" content="Jose Storopoli, PhD - personal website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@storopoli">
    <meta name="twitter:author" content="@storopoli">
    <meta name="twitter:description" content="Jose Storopoli, PhD - personal website">
    <meta name="twitter:title" content="Sherlock Holmes Final Letter: A Simple Dead Man&apos;s Switch in Rust | @stropoli">
    <meta name="twitter:image" content="https://storopoli.io/pp.jpg">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Sherlock Holmes Final Letter: A Simple Dead Man&apos;s Switch in Rust | @storopoli">
    <meta property="og:image" content="https://storopoli.io/pp.jpg">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title id="title">
      Sherlock Holmes Final Letter: A Simple Dead Man&apos;s Switch in Rust
      - @storopoli
    </title>
    <link rel="stylesheet" type="text/css" href="/main.css">
    <link rel="stylesheet" type="text/css" href="/fonts.css">
    <link rel="stylesheet" type="text/css" href="/fira_code.css">
    <link rel="stylesheet" type="text/css" href="/highlight.css">
    <link type="text/css" rel="stylesheet" href="/term-highlight.css">
    
  </head>
  <body>
    <div id="content">
      <style>
        h1,
        h2,
        h3 {
          text-align: center;
        }

        .profile-pic {
          border-radius: 50%;
          border: 5px solid lightblue;
          margin-top: 1rem;
        }
      </style>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <h1 id="header" class="noupper" style="margin-bottom:0;">
          Jose Storopoli, PhD
        </h1>
        <div class="menu" style="display:flex; justify-content:center; ">
          <a href="/">Home</a>
          •
          <a href="/blog/">Blog</a>
          •
          <a href="https://github.com/storopoli" target="_blank">
            GitHub
          </a>
          •
          <a href="/publickey.txt" target="_blank">
            PGP
          </a>
          •
          <a href="/index.xml" rel="alternate" type="application/rss+xml">
            RSS
          </a>
        </div>
      </div>
      
  <h1>Sherlock Holmes Final Letter: A Simple Dead Man&apos;s Switch in Rust</h1>
  <p class="post-byline">
    <span>March 23, 2024</span>
    •
    <span>10</span>
    min read • by
    <b>Jose Storopoli, PhD</b>
    <span></span>
  </p>
  <div id="post-description"></div>
  <div>
    <div class="toc block info">
      <h1>&nbsp;Table of Contents</h1>
      <div><ul>
<li>
<ul><li>
Dead Man’s Switch</li><li>How to Use It</li><li>The Implementation Details</li><li>Contributions are Welcome</li><li>Conclusion</li></ul></ul></div>
    </div>
  </div>
  <div></div>
  <div id="content">
    <div id="post-body"><p><figure><img src="/blog/2024-03-23-dead-man-switch/the_final_problem.png" alt="">
<figcaption>Sherlock Holmes fights Moriarty at the Reichenbach Falls</figcaption></figure></p><p>Got state secrets? Or maybe 50 BTC? Don’t trust your government or lawyers? And you want to make sure that if you die, your secrets are passed on? Don’t worry, I got you covered. In this post, I’ll introduce you to a <strong>simple no-bullshit dead man’s switch</strong> written in Rust.</p><h2>Dead Man’s Switch</h2><p>According to <a href="https://en.wikipedia.org/wiki/Dead_man%27s_switch" target="_blank">Wikipedia</a>:</p><blockquote><p>A <strong>dead man’s switch</strong> is a switch that is designed to be <strong>activated or deactivated if the human operator becomes incapacitated</strong>, such as through death, loss of consciousness, or being bodily removed from control. Originally applied to switches on a vehicle or machine, it has since come to be used to describe other intangible uses, as in <strong>computer software</strong>.</p></blockquote><p>A Dead Man’s Switch (DMS) can be handy and common scenarios might be:</p><ul><li><strong>Password to your encrypted files</strong>: You gave a trusted person an encrypted USB drive and the DMS sends the password to decrypt it.</li><li><strong>Bitcoin Multisig</strong>: Sending 1 of 3 keys to a trusted person. You hold 1 key, your friend holds another key, and the DMS holds the last key.</li><li><strong>Instructions</strong>: Sending instructions on how to access something of value or importance.</li><li><strong>Goodbye Note</strong>: Sending a goodbye note to loved ones.</li></ul><p>A DMS is specially useful when you don’t trust the government or lawyers to handle your affairs after you die. It’s also useful when you don’t want to disclose your secrets while you are alive.</p><p>The idea is simple:</p><ol><li><strong>You set up a DMS</strong>.</li><li><strong>You need to check in periodically</strong>.</li><li><strong>If you don’t check in, the DMS is triggered</strong>.</li></ol><p>In this post opening picture, is depicted an image from Conan Doyle’s story <a href="https://en.wikipedia.org/wiki/The_Final_Problem" target="_blank">The Final Problem</a>, where Sherlock Holmes fights Moriarty at the Reichenbach Falls. Eventually, both fall to their deaths. I am pretty confident that Sherlock Holmes had a DMS in place to send Watson a message.</p><p>I’ve tried finding nice implementations of DMS, but to no avail. They all were either unmaintained or plaged with spaghetti code. My inspiration to build one came from two sources. First, a friend of mine told me that he is using a bunch of badly-written shell scripts with some cron jobs to manage his DMS. Second, there might be a genuine need for a simple DMS in the privacy community. For example, <a href="https://finalmessage.io" target="_blank">finalmessage.io</a>, despite being closed source, and you have no idea who’s behind it, has gathered enough users in a subscription model and they are not accepting new users anymore. If people are paying for this, they can pay for a Linux server somewhere. But they would need a simple DMS to run on it.</p><h2>How to Use It</h2><div class="block info"><h1>Disclaimer</h1><p>Use at your own risk. Check the f****(as in <em>friendly</em>) code.</p></div><p>I invite you to check out the code on GitHub at <a href="https://github.com/storopoli/dead-man-switch" target="_blank"><code>storopoli/dead-man-switch</code></a>. The license is <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank">AGPL-3.0</a>, which means you can use it for free as long as you share your code. The package is also available on <a href="https://crates.io/crates/dead-man-switch" target="_blank">crates.io</a>, Rust’s package manager.</p><p>DMS is very easy to use and deploy. There are several alternatives on how to deploy it. Here are the two easiest ways:</p><ol><li><p><strong>Building from Source</strong>:</p><ol><li><p>In a fresh Debian/Ubuntu server install the following dependencies:</p><pre><code class="bash"><span class="constant">sudo</span> <span class="constant">apt-get</span> <span class="constant">install</span> <span class="constant">-y</span> <span class="constant">cargo</span> <span class="constant">pkg-config</span> <span class="constant">libssl-dev</span>
</code></pre>
</li><li><p>Install the DMS:</p><pre><code class="bash"><span class="constant">cargo</span> <span class="constant">install</span> <span class="constant">dead-man-switch-tui</span>
</code></pre>
</li><li><p>Run the app with:</p><pre><code class="bash"><span class="constant">dead-man-switch-tui</span>
</code></pre>
</li></ol></li><li><p><strong>Using Nix</strong>. This is the easiest just do <code>nix run github:storopoli/dead-man-switch</code>.</p></li></ol><div class="block info"><p> I’ve also released a Web Interface for the dead-man-switch. You can easily deploy it using Docker or Docker Compose. Check out the <a href="https://github.com/storopoli/dead-man-switch" target="_blank">GitHub repository</a>.</p><p>I’ve also launched a <a href="https://start9.com" target="_blank">StartOS</a> app with a simple interface for configuring and checking in with the Dead Man’s Switch. Check out the instructions on the <a href="https://github.com/storopoli/dead-man-switch-startos" target="_blank"><code>dead-man-switch-startos</code> repository</a>.</p></div><p>Once, you successfully run the app, you will see the following output:</p><p><figure><img src="/blog/2024-03-23-dead-man-switch/app_first_run.png" alt="">
<figcaption>Initial Screen of Dead Man’s Switch</figcaption></figure></p><p>If you read the instructions carefully, all you need to know is detailed in these 3 steps:</p><ol><li>Edit the Config at <code>/root/.config/deadman/config.toml</code> and modify the settings.</li><li>Check-In with <code>c</code> within the warning time.</li><li>Otherwise the Dead Man’s Switch will be triggered and the message with optional attachment will be sent.</li></ol><p>Upon the first run, the app will create a configuration file at an OS-agnostic config file location:</p><ul><li>Linux: <code>$XDG_CONFIG_HOME</code>, i.e. <code>$HOME/.config|/home/alice/.config</code></li><li>macOS: <code>$HOME/Library/Application Support</code>, i.e. <code>/Users/Alice/Library/Application Support</code></li><li>Windows: <code>{FOLDERID_RoamingAppData}</code>, i.e. <code>C:\Users\Alice\AppData\Roaming</code></li></ul><p>In this example, I am running it from a Debian server as the <code>root</code> user. Hence, the configuration file is at <code>/root/.config/deadman/config.toml</code>.</p><p>If you open the configuration file, you will see the following content. I’ve added some default values for inspiration[^central-park]:</p><div class="block info"><p> Please don’t go to bench 137 in Central Park, NY. That was just an example.</p></div><pre><code class="toml"><span class="property">username</span> <span class="operator">=</span> <span class="string">&quot;me@example.com&quot;</span>
<span class="property">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>
<span class="property">smtp_server</span> <span class="operator">=</span> <span class="string">&quot;smtp.example.com&quot;</span>
<span class="property">smtp_port</span> <span class="operator">=</span> <span class="number">587</span>
<span class="property">message</span> <span class="operator">=</span> <span class="string">&quot;I&apos;m probably dead, go to Central Park NY under bench #137 you&apos;ll find an age-encrypted drive. Password is our favorite music in Pascal case.&quot;</span>
<span class="property">message_warning</span> <span class="operator">=</span> <span class="string">&quot;Hey, you haven&apos;t checked in for a while. Are you okay?&quot;</span>
<span class="property">subject</span> <span class="operator">=</span> <span class="string">&quot;[URGENT] Something Happened to Me!&quot;</span>
<span class="property">subject_warning</span> <span class="operator">=</span> <span class="string">&quot;[URGENT] You need to check in!&quot;</span>
<span class="property">to</span> <span class="operator">=</span> <span class="string">&quot;someone@example.com&quot;</span>
<span class="property">from</span> <span class="operator">=</span> <span class="string">&quot;me@example.com&quot;</span>
<span class="property">timer_warning</span> <span class="operator">=</span> <span class="number">1209600</span>
<span class="property">timer_dead_man</span> <span class="operator">=</span> <span class="number">604800</span>
</code></pre>
<p>The configs are self-explanatory. You might need some help to set up and find a reliable SMTP server. One option is to use Gmail. Unfortunately, Proton or Tutanota are not supported because they don’t support SMTP. Just grab the support page of your email provider and search for SMTP settings. Plug the values in and you are good to go.</p><p>I want to bring your attention to the <strong><code>timer_warning</code></strong> and <strong><code>timer_dead_man</code></strong> configs. These are very important.</p><p>The way DMS works is by <strong>checking in periodically</strong>. If you <strong><em>don’t</em> check in within the <code>timer_warning</code> time, the DMS will send a warning message to your own email</strong>, i.e. the <code>from</code> email declared in the config, with the message <code>message_warning</code> and subject <code>subject_warning</code>.</p><p>If you <strong><em>still don’t check in</em> within the <code>timer_dead_man</code> time, the DMS will send the “Dead Man’s” message to the <code>to</code> email declared in the config</strong>, with the message <code>message</code> and subject <code>subject</code>.</p><p>The timers are in <strong>seconds</strong>, and the <strong>default values</strong> are:</p><ul><li><strong>Warning Timer</strong>: 2 weeks</li><li><strong>Dead Man’s Timer</strong>: 1 week</li></ul><p>Feel free to change these values to your liking.</p><p>You can also add an attachment to the Dead Man’s Message. Just add an <code>attachment</code> field to the config file with the <em>absolute</em> path to the file. For example:</p><pre><code class="toml"><span class="property">attachment</span> <span class="operator">=</span> <span class="string">&quot;/root/important_file.txt&quot;</span>
</code></pre>
<p>A good idea is to make this file encrypted. Actually, it’s even better if you encrypted the whole fucking thing. You can use <a href="https://gnupg.org/" target="_blank">PGP</a> or <a href="https://age-encryption.org" target="_blank"><code>age</code></a>. For example, this is a PGP-encrypted message:</p><pre><code>-----BEGIN PGP MESSAGE-----

jA0ECQMKDpTufzWBF+//0ukBT/vslTBHGlMeri/cqpkxO2X7ZY1SYwiYwDqvdFAV
FGzPHUaGh8tQiuoh7tj0HJEIqBaktJoDNe3XsszFVSp3eQAAiWUh+t/5pTIcQhW9
iKJHPUKGhqf9vg0Q4LS0F1RMhLejoeXt/TvtHfsHE+kymbvp8p5gNiwoyugEZlta
qLd0ZJvMDg5c0/Qw81+e6jW0ApwcT7MVf/Y0dFKW1epsA1QfGH5rQYUWPJDP+SZR
hBd5034eKNKTUZYwAAoR0UJ6eqcnev9z9sTuct3uGPeXnNqK0zDKaP3rV/9hnVPN
3gwEQEWL2Dl39pjv+x+QdViCirlrjPa0BaHzwveid2N8Ik3QBsxKGkyAXd0w3G+g
VAGwKDLUkXUIDytk/PI8vRGLUhSmyG29KdeGdEiKde+DG5MUtjC4UyFCWxa5ZX5y
WNEg7049bd5Nx3B5WlFmKyWbsHynoziDJU2aq2uvaBLYA48roDN/0sEUsuGFpxm3
0/3vd0kGxMt20HlsVpDRQz75mWJEmzxY2itRJbR84bEyN0ItWE9G5WwQ4mjmU+XL
0xYazglNYoAG0FXCxD6EpbDbQZxO/OKIaGWI4d2Zs1zcwbcEfZnhsKB5kI4tYJZ2
ZTq+Q4xY4sFEoYzmNQbHY+mpgskgmHbRdBAGea+raiAXK/wL4Qc9x1bDdNIKNBup
lsCRA1Dj/5s0Qy64d2cbfWvCvx3R9B0JsHTcFq4DBELSOzSyzC/mpCXCAi9K/jE5
5VAnsnqaTZm+DVpciMTRxuRPD50MDYogTA/N+Jer9WmQOgc0e1VrWsho2CgX0Z8I
ycF56Wm+lBjTGRMLXexA1Ietm88wg/OrY6BE57xpBMVemRc0P0A2g0KC1WkX8J3I
fw5IKoiGsd9mvuHNxJ40Rm14iTYV0z9t97GFTmWji5BZtKoQ8vNmy8skgEgEUuHS
LtwCU8D5XsHQY2EWsQv23KPyxpbdvl7vGP75xCzRqcWmeCMSyH1qYPsO87sPJ4eL
Z4ywlr9ULagMgNMK/KO7F45yJRCqGKCaYB3cpcEpgUIIlZRCiXZSUifb/0EMWNAb
DzV/otFp8aMrhwGxIEYv1wOmot9OrBRVgLVSNTU9EtJVzISEowbhe+7ZP1jUaAaW
WrjvDA==
=cfGG
-----END PGP MESSAGE-----
</code></pre><p>In this message there’s a nice Easter Egg for you, my friend. The password is the name of the waterfall depicted in this post, all together and in PascalCase.</p><p>Upon checking in, the timer will be reset to the Warning Timer, even if you are already in the Dead Man’s Timer.</p><p>If both timers run out, the messages will be sent and DMS will exit.</p><h2>The Implementation Details</h2><blockquote><p>For the stupid smelly nerds that want to go beyond the <a href="https://github.com/sherlock-project/sherlock/issues/2019" target="_blank">“JUST MAKE A FUCKING .EXE AND GIVE IT TO ME”</a>.</p></blockquote><p>Before we dive into the code, here are the <strong>dependencies</strong> that I am using. I’ve tried to keep them to a minimum, since I want this to be a dead-simple program. This also helps with reducing the incidence of bugs and narrowing the attack surface:</p><ul><li><a href="https://ratatui.rs" target="_blank"><code>ratatui</code></a> for the Terminal User Interface (TUI)</li><li><a href="https://serde.rs" target="_blank"><code>serde</code></a>, <a href="https://crates.io/crates/toml" target="_blank"><code>toml</code></a>, and <a href="https://crates.io/crates/directories-next" target="_blank"><code>directories-next</code></a> for managing the TOML configuration file.</li><li><a href="https://lettre.rs" target="_blank"><code>lettre</code></a> to manage email sending, and <a href="https://crates.io/crates/mime_guess" target="_blank"><code>mime_guess</code></a> to robustly handle optional attachments.</li><li><a href="https://crates.io/crates/chrono" target="_blank"><code>chrono</code></a> to handle timers and date/time formatting.</li></ul><div class="block info"><p> The Dead Man’s Switch Web Interface uses <a href="https://github.com/tokio-rs/axum" target="_blank"><code>axum</code></a>, <a href="https://djc.github.io/askama/" target="_blank"><code>askama</code></a> and <a href="https://github.com/tower-rs/tower" target="_blank"><code>tower</code></a>.</p></div><p>The app is divided into a library and a binary. The library is contained in the <code>lib.rs</code> file and the binary in the <code>main.rs</code>, both under the <code>src/</code> directory. Here’s a representation of the structure of <code>src/</code>:</p><pre><code class="bash"><span class="constant">src/</span>
<span class="constant">├──</span> <span class="constant">config.rs</span>
<span class="constant">├──</span> <span class="constant">email.rs</span>
<span class="constant">├──</span> <span class="constant">lib.rs</span>
<span class="constant">├──</span> <span class="constant">main.rs</span>
<span class="constant">├──</span> <span class="constant">timer.rs</span>
<span class="constant">└──</span> <span class="constant">tui.rs</span>
</code></pre>
<p>As we can see, it is divided into 4 modules:</p><ul><li><strong><code>config.rs</code></strong>: Handles the configuration file.</li><li><strong><code>email.rs</code></strong>: Handles the email sending.</li><li><strong><code>timer.rs</code></strong>: Handles the timers and timer logic.</li><li><strong><code>tui.rs</code></strong>: Handles the Terminal User Interface (TUI).</li></ul><p>Feel free to dive in any of these files to understand the implementation details. I’ve made sure that the code is <em>both</em> <strong>well-tested</strong> and <strong>well-documented</strong>.</p><h2>Contributions are Welcome</h2><p>If you want to contribute to the project, feel free to open a pull request. I’ve marked a few issues as <code>good first issue</code> to help you get started. Check out the <a href="https://github.com/storopoli/dead-man-switch" target="_blank">GitHub repository</a>.</p><h2>Conclusion</h2><p>I’ve built a simple no-bullshit Dead Man’s Switch so that any person can use it. Feel free to use it and share it with your friends. Let’s hope that we don’t go to a dystopian future where everyone needs to use it. Although, I am pretty sure that Sherlock Holmes would have used it no matter what. Probably the way he would have used it is by:</p><ol><li>Set-up a non-KYC email account that supports SMTP.</li><li>Sign-up for a non-KYC VPS with Bitcoin or Monero.</li><li>Access the VPS via Tor using Tails.</li><li>Change the server’s default SSH port to a random one.</li><li>Disallow password authentication and only allow key-based authentication.</li><li>Encrypt everything in the case the server is seized.</li></ol><div class="block info"><p> Sherlock could also use a coreboot non-KYC piece of hardware that runs StartOS and the newly launched Dead Man’s Switch StartOS app that already uses an onion service for handling the check-ins via Tor.</p></div></div>
  </div>
  <hr>
  <div id="prev-next">
    <span>
      <a href="/blog/2024-02-11-mnemonic/">←
        <span>Seed Phrases and Entropy</span></a>
    </span>
    <span>&nbsp; • &nbsp;</span>
    <span>
      <a href="/blog/2024-04-14-shamir-secret-sharing/"><span>Shamir&apos;s Secret Sharing</span>
        →</a>
    </span>
    <small>&nbsp; or &nbsp;</small>
    <small>
      <a href="/">Back to the Homepage</a>
    </small>
  </div>

    </div>
    <footer id="footer">
      <small class="noupper" style="color:#606060;font-weight:normal;">
        <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">
          CC-BY-SA 4.0
        </a>
        &nbsp;
        —
        &nbsp;
        <a href="https://github.com/storopoli" target="_blank">
          Jose Storopoli, PhD
        </a>
        &nbsp;
        —
        &nbsp;
        <i>made with &nbsp;
          <a href="https://zine-ssg.io" target="_blank">
            <img src="/zig-logo-light.svg" height="13">
          </a></i>
      </small>
      
    </footer>
  </body>
</html>
